# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Photo Scoring CLI - analyzes photo collections using multiple vision models (Qwen, Gemini via OpenRouter), scores them on aesthetic and technical quality, and produces ranked CSV output with AI-generated critiques.

**Core principle**: Inference once, score many times. Vision model inference is cached in `~/.photo_score/cache.db`; scoring/explanation logic runs instantly from cached attributes.

**Cost**: ~$0.005 per image (7 API calls)

## Quick Start

```bash
# Install dependencies
uv sync

# Set API key
export OPENROUTER_API_KEY="your-key"

# Score photos
uv run python calibrate.py -i /path/to/photos -o results.csv

# View results in web UI
uv run python serve_viewer.py --photos /path/to/photos --csv results.csv
# Open http://localhost:8080
```

## Claude Code Skills

Use these slash commands for common tasks:

- `/score-photos [directory]` - Score a batch of photos
- `/start-viewer [csv] [photos]` - Start the web viewer
- `/run-tests` - Run test suite with coverage
- `/check-costs [count]` - Estimate API costs

## Build and Development Commands

```bash
# Install dependencies (with uv - recommended)
uv sync --dev

# Run tests
uv run pytest -v

# Run tests with coverage
uv run pytest --cov=photo_score --cov-report=term-missing

# Lint and format
uv run ruff check .
uv run ruff format .

# Auto-fix issues
uv run ruff check --fix .
uv run ruff format .

# Run calibration script
uv run python calibrate.py -i ./test_photos -o results.csv -n 10

# Start web viewer
uv run python serve_viewer.py --photos ./test_photos --csv results.csv
```

## Environment Variables

- `OPENROUTER_API_KEY`: Required for vision model inference

## Local Data Storage

Generated files are stored locally and excluded from version control:

- **Results CSV files** (`*.csv`): Generated in the directory you specify with `-o`
- **Inference cache** (`~/.photo_score/cache.db`): SQLite database storing raw model responses and normalized attributes
- **Correction exports** (`photo_corrections_*.json`, `photo_scores_corrected_*.csv`): Generated by the web viewer

All these file patterns are in `.gitignore` to prevent accidental commits.

## Project Structure

```
photo_score/
  cli.py                # Typer CLI entry point (run, rescore commands)
  ingestion/
    discover.py         # Recursive image discovery with SHA256 hashing
    metadata.py         # EXIF extraction
  inference/
    client.py           # OpenRouter API client
    prompts.py          # Vision model prompts for aesthetic/technical analysis
    schemas.py          # Pydantic response schemas
  scoring/
    reducer.py          # Weighted score computation with thresholds
    explanations.py     # Deterministic template-based explanations
  storage/
    cache.py            # SQLite cache (~/.photo_score/cache.db)
    models.py           # Pydantic data models
  config/
    loader.py           # YAML config loading
    schema.py           # Config validation schemas
  output/
    csv_writer.py       # CSV output generation
tests/                  # pytest test suite
configs/default.yaml    # Default scoring configuration
```

## Architecture Notes

1. **Attributes**: All normalized to [0, 1] range
   - Aesthetic: composition, subject_strength, visual_appeal
   - Technical: sharpness, exposure_balance, noise_level

2. **Scoring reducer** (`scoring/reducer.py`): Weighted sum with hard thresholds. Exposes per-attribute contributions for explanations.

3. **Explanations** (`scoring/explanations.py`): Template-driven, deterministic, weight-aware. No LLM calls.

4. **Caching** (`storage/cache.py`): SQLite at `~/.photo_score/cache.db`. Stores image_id (SHA256), raw model outputs, normalized attributes.

5. **Two-pass inference**: Aesthetic prompt and technical prompt run separately against OpenRouter, results merged into NormalizedAttributes.

## CLI Usage

```bash
# Full run (discovery + inference + scoring + CSV output)
photo-score run \
  --input ./photos/japan \
  --config ./configs/default.yaml \
  --output ./outputs/japan_scores.csv

# Re-score from cache (instant, no API calls)
photo-score rescore \
  --input ./photos/japan \
  --config ./configs/high_sharpness.yaml \
  --output ./outputs/japan_rescored.csv
```
